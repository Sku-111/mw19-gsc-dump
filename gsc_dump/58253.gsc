// IW8 GSC SOURCE
// Generated by https://github.com/xensik/gsc-tool

subscribetoquestlocale()
{
    init_vfx();
    init_dvars();
}

init_vfx()
{
    level._effect["vfx_br_decontamination_station_circle_blue"] = loadfx( "vfx/iw8/prop/scriptables/vfx_br_decontamination_station_circle_blue" );
    level._effect["vfx_br_decontamination_station_circle_steam"] = loadfx( "vfx/iw8_br/island/equip/decon/vfx_br3_decon_steam" );
    level._effect["vfx_br_decontamination_station_circle_aura"] = loadfx( "vfx/iw8_br/island/equip/decon/vfx_br3_decon_aura" );
    level._effect["vfx_decon_station_screen_fx"] = loadfx( "vfx/iw8_br/island/equip/decon/vfx_br3_decon_scrnfx" );
}

init_dvars()
{
    if ( !isdefined( level.iswztrain ) )
    {
        level.iswztrain = spawnstruct();
        level.iswztrain.instances = [];
    }

    level.iswztrain.lifetime = getdvarfloat( "scr_decon_station_lifetime", 13.0 );
    level.iswztrain.weaponswitchhintlogic = getdvarfloat( "scr_decon_station_lifetime_last_circle", -1 );
    level.iswztrain._id_142CD = getdvarfloat( "scr_decon_station_visibility_delay", 0.1 );
    level.iswztrain.infinite_ammo = getdvarint( "scr_decon_station_infinite_ammo", 0 );
}

jugg_protect_jammer()
{
    self.jugg_pursue_target = undefined;
    var_0 = scripts\mp\equipment::getequipmentmaxammo( "equip_decon_station" );

    for ( var_1 = 0; var_1 < var_0; var_1++ )
        javelin_interact_monitor();
}

javelin_interact_monitor( var_0 )
{
    if ( !isdefined( self.jugg_pursue_target ) )
        self.jugg_pursue_target = [];

    if ( self.jugg_pursue_target.size < jug_trig_spawn() )
    {
        if ( !isdefined( var_0 ) )
            var_0 = 3;

        self.jugg_pursue_target[self.jugg_pursue_target.size] = var_0;
    }
}

jugg_modifyherodroptoplayerdamage()
{
    if ( isdefined( self.jugg_pursue_target ) && self.jugg_pursue_target.size > 0 )
    {
        var_0 = self.jugg_pursue_target[self.jugg_pursue_target.size - 1];
        self.jugg_pursue_target[self.jugg_pursue_target.size - 1] = undefined;
        return var_0;
    }

    return undefined;
}

jugg_modifyfalldamage()
{
    self.jugg_pursue_target = undefined;
}

jugg_go_to_node_callback( var_0, var_1 )
{
    jugg_modifyfalldamage();
}

jugg_getminigunweapon( var_0, var_1 )
{
    jugg_protect_jammer();
}

jug_trig_spawn()
{
    return scripts\mp\equipment::getequipmentmaxammo( "equip_decon_station" );
}

jug_reinforce()
{
    jug_encounter_test( undefined, 0, 0.15 );
}

jugg_dmg_debug()
{
    jug_encounter_test( undefined, 0, 0.15 );
}

jeep_initomnvars( var_0 )
{
    var_0 endon( "death" );
    self endon( "disconnect" );
    var_0.owner = self;
    var_0 setotherent( var_0.owner );
    var_0 setnodeploy( 1 );
    var_0.issuper = isdefined( var_0.owner.super ) && var_0.owner.super.staticdata.weapon == "decon_station_mp";
    var_0.superid = level.superglobals.staticsuperdata["super_decon_station"].id;
    var_0.usedcount = 0;
    var_0 scripts\cp_mp\ent_manager::registerspawn( 2, ::jug_reinforce );
    var_0 thread jeep_initcollision();
    var_0 thread jeep( var_0.owner );
    var_0 waittill( "missile_stuck", var_1 );
    var_0.owner thread scripts\mp\weapons::monitordisownedgrenade( var_0.owner, var_0 );
    scripts\mp\utility\print::printgameaction( "trophy spawned", self );

    if ( !istrue( var_0.issuper ) )
    {
        var_0.ammo = jugg_modifyherodroptoplayerdamage();

        if ( !isdefined( var_0.ammo ) )
            var_0.ammo = 3;

        var_0 thread scripts\mp\weapons::makeexplosiveusabletag( "tag_use", 1 );
    }
    else
        var_0.ammo = 3;

    var_0.owner scripts\mp\weapons::onequipmentplanted( var_0, "equip_decon_station", ::jugg_dmg_debug );
    var_0 thread scripts\mp\weapons::monitordisownedequipment( var_0.owner, var_0 );
    var_0 scripts\mp\sentientpoolmanager::registersentient( "Tactical_Static", var_0.owner );
    var_0.explosion = jeep_horn();
    var_2 = var_0.owner scripts\mp\utility\perk::_hasperk( "specialty_rugged_eqp" );

    if ( var_2 )
        var_0.hasruggedeqp = 1;

    var_3 = scripts\engine\utility::ter_op( var_2, 200, 100 );
    var_4 = "hitequip";
    var_0 thread scripts\mp\damage::monitordamage( var_3, var_4, ::jugg_canreload, ::jugg_canparachute, 0 );
    var_0 scripts\cp_mp\emp_debuff::set_apply_emp_callback( ::jugg_assault3_check_size );
    var_0 setscriptablepartstate( "visibility", "show", 0 );
    var_0 thread javelin_forceclear();
}

javelin_forceclear()
{
    self endon( "death" );
    self setscriptablepartstate( "effects", "activeLand" );

    if ( level.gametype == "br" )
        self.ignoreme = 1;

    wait 0.1;
    thread joininprogresstimeout();
    thread jugg_pursue_players( 1 );
    wait 0.4;
    self.headiconid = scripts\cp_mp\entityheadicons::setheadicon_factionimage( 0, 20, undefined, undefined, undefined, undefined, 1 );
    thread scripts\mp\weapons::outlineequipmentforowner( self );
    self._id_13B97 = gettime();
    self._id_13B96 = gettime() + level.iswztrain.lifetime * 1000;
    level.iswztrain.instances = scripts\engine\utility::array_add( level.iswztrain.instances, self );
    var_0 = self.origin - ( 0, 0, 125 );
    var_1 = 20;
    var_2 = var_0 + ( 0, 0, var_1 );
    var_3 = spawn( "trigger_radius", var_2, 0, 250, 250 );
    scripts\mp\utility\trigger::makeenterexittrigger( var_3, ::jugg_combo, ::jugg_enter_combat_callback, undefined, undefined, ::jugg_get_priority_player );
    var_3.tracknonoobplayerlocation = self;
    var_3 enablelinkto();
    var_3 linkto( self );
    self.trigger = var_3;
    scripts\mp\gametypes\br_quest_util.gsc::init_tactical_boxes( 3, 0, 1, self.origin );
    scripts\mp\gametypes\br_quest_util.gsc::_id_13369();
    scripts\mp\gametypes\br_quest_util.gsc::_id_1316F( 250 );
    var_4 = level.iswztrain.lifetime;

    if ( isdefined( level.br_circle ) && scripts\mp\gametypes\br_circle.gsc::islastcircle() && level.iswztrain.weaponswitchhintlogic > 0 )
        var_4 = level.iswztrain.weaponswitchhintlogic;

    wait( var_4 );
    jug_encounter_test( undefined, 0, 0.15 );
    jugg_canuseweaponpickups();
    thread scripts\mp\equipment_interact::remoteinteractsetup( ::jug_encounter_test, 1, 1 );
    thread scripts\mp\perks\perk_equipmentping::runequipmentping();
}

jugg_idle_until_shot_or_near( var_0 )
{
    self.start_death_from_above_sequence = 1;
    thread jugg_modifyvehicletoplayerdamage();
    var_1 = int( ( var_0._id_13B96 - gettime() ) / 1000 );
}

jugg_managestockammo()
{
    self.start_death_from_above_sequence = 0;
    jugg_objective_struct();
}

jugg_disableoverlayonentergulag()
{
    if ( !isdefined( self.gastriggerstouching ) )
        self.gastriggerstouching = [];

    if ( self.gastriggerstouching.size > 0 )
    {
        foreach ( var_1 in self.gastriggerstouching )
        {
            if ( !isdefined( var_1 ) )
                continue;

            if ( scripts\engine\utility::array_contains( var_1.playersintrigger, self ) )
            {
                scripts\mp\equipment\gas_grenade::gas_onexittrigger( var_1 getentitynumber() );
                return 1;
            }
        }
    }

    return 0;
}

jugg_get_closest_attackable_player()
{
    if ( !isdefined( self.gastriggerstouching ) )
        self.gastriggerstouching = [];

    if ( self.gastriggerstouching.size > 0 )
    {
        foreach ( var_1 in self.gastriggerstouching )
        {
            if ( !isdefined( var_1 ) )
                continue;

            if ( scripts\engine\utility::array_contains( var_1.playersintrigger, self ) )
            {
                scripts\mp\equipment\gas_grenade::gas_onentertrigger( var_1 );
                return 1;
            }
        }
    }

    return 0;
}

jugg_combo( var_0, var_1 )
{
    var_2 = gettime() + 500 >= var_1.tracknonoobplayerlocation._id_13B96;

    if ( !var_2 && jugg_addtoactivejugglist( var_0 ) && !istrue( var_1.tracknonoobplayerlocation._id_122F2 ) )
    {
        var_3 = var_0;
        var_3.start_death_from_above_sequence = 1;
        var_3 jugg_idle_until_shot_or_near( var_1.tracknonoobplayerlocation );
        var_3 jugg_disableoverlayonentergulag();
        var_1.tracknonoobplayerlocation jugg_maze_killtrigger( var_3 );

        if ( scripts\cp_mp\gasmask::hasgasmask( var_3 ) )
        {
            var_3 scripts\mp\gametypes\br_pickups.gsc::plunderrankupdate( "br_circle" );
            var_3 scripts\mp\gametypes\br_pickups.gsc::plunderrankupdate( "city_killer" );
            var_3 scripts\mp\gametypes\br_pickups.gsc::plunderrankupdate( "chem_factory_gas" );
        }

        if ( isplayer( var_3 ) )
            var_3 scripts\mp\equipment\gas_grenade::gas_clear( 0 );
    }
}

jugg_enter_combat_callback( var_0, var_1 )
{
    if ( jugg_addtoactivejugglist( var_0 ) )
    {
        var_2 = var_0;
        var_2 jugg_managestockammo();
        var_2 jugg_get_closest_attackable_player();
    }
}

jugg_get_priority_player( var_0, var_1 )
{
    if ( jugg_addtoactivejugglist( var_0 ) || isdefined( var_0.vehicletype ) )
        return 0;

    return 1;
}

jugg_maze_killtrigger( var_0 )
{
    if ( !isdefined( self.trigger.participants ) )
        self.trigger.participants = [];

    if ( scripts\engine\utility::array_contains( self.trigger.participants, var_0 ) )
        return;

    self.trigger.participants = scripts\engine\utility::array_add( self.trigger.participants, var_0 );
}

jugg_addtoactivejugglist( var_0 )
{
    return isplayer( var_0 ) || isagent( var_0 ) || isbot( var_0 );
}

jugg_pursue_players( var_0 )
{
    var_1 = "j_body";

    if ( var_0 )
        playfxontag( scripts\engine\utility::getfx( "vfx_br_decontamination_station_circle_aura" ), self, var_1 );
    else
        killfxontag( scripts\engine\utility::getfx( "vfx_br_decontamination_station_circle_aura" ), self, var_1 );

    for ( var_2 = 1; var_2 <= 3; var_2++ )
    {
        var_3 = "tag_fx";

        if ( var_2 > 1 )
            var_3 = var_3 + scripts\engine\utility::string( var_2 );

        playfxontag( scripts\engine\utility::getfx( "vfx_br_decontamination_station_circle_steam" ), self, var_3 );
    }
}

jugg_protect_jammer_internal()
{
    killfxontag( scripts\engine\utility::getfx( "vfx_br_decontamination_station_circle_aura" ), self, "j_body" );

    for ( var_0 = 1; var_0 <= 3; var_0++ )
    {
        var_1 = "tag_fx";

        if ( var_0 > 1 )
            var_1 = var_1 + scripts\engine\utility::string( var_0 );

        stopfxontag( scripts\engine\utility::getfx( "vfx_br_decontamination_station_circle_steam" ), self, var_1 );
    }
}

joininprogresstimeout()
{
    self endon( "death" );
    self setscriptablepartstate( "effects", "activeDeployStart" );
    wait( jug_spawn_func() );
    self setscriptablepartstate( "effects", "activeDeployEnd" );
}

#using_animtree("scriptables");

jug_spawn_func()
{
    return getanimlength( %wm_trophy_system_deploy_landing );
}

jugg_assault3_check_size( var_0 )
{
    var_1 = var_0.victim;
    var_1 jug_trigger_spawn( var_0.attacker );
    var_1 jugg_canuseweaponpickups();
    var_1 thread jug_encounter_test( var_0.attacker, 1 );
}

jugg_modifyvehicletoplayerdamage()
{
    if ( isagent( self ) )
        return;

    if ( istrue( self.isx1ops ) )
        return;

    self.isx1ops = 1;
    stopfxontag( scripts\engine\utility::getfx( "vfx_decon_station_screen_fx" ), self, "j_head" );
    waitframe();
    var_0 = playfxontagforclients( scripts\engine\utility::getfx( "vfx_decon_station_screen_fx" ), self, "j_head", self );
}

jugg_objective_struct( var_0 )
{
    if ( isagent( self ) )
        return;

    if ( istrue( var_0 ) )
        killfxontag( scripts\engine\utility::getfx( "vfx_decon_station_screen_fx" ), self, "j_head" );

    stopfxontag( scripts\engine\utility::getfx( "vfx_decon_station_screen_fx" ), self, "j_head" );
    self.isx1ops = 0;
}

jugg_canparachute( var_0 )
{
    var_1 = var_0.attacker;
    var_2 = var_0.objweapon;
    var_3 = var_0.meansofdeath;
    var_4 = var_0.damage;
    var_5 = var_4;
    var_5 = scripts\mp\damage::handlemeleedamage( var_2, var_3, var_5 );
    var_5 = scripts\mp\damage::handleapdamage( var_2, var_3, var_5 );
    scripts\mp\weapons::equipmenthit( self.owner, var_1, var_2, var_3 );
    return var_5;
}

jugg_canuseweaponpickups()
{
    if ( !isdefined( self.trigger.participants ) )
        self.trigger.participants = [];

    var_0 = scripts\engine\utility::array_combine_unique( self.trigger.triggerenterents, self.trigger.participants );

    foreach ( var_2 in var_0 )
        var_2 jugg_enter_combat_callback( var_2, self.trigger );

    jugg_protect_jammer_internal();
    level.iswztrain.instances = scripts\engine\utility::array_remove( level.iswztrain.instances, self );

    if ( isdefined( self.mapcircle ) )
        scripts\mp\gametypes\br_quest_util.gsc::lastdirtyscore();

    waitframe();

    if ( isdefined( self.trigger ) )
        self.trigger delete();

    self notify( "disperse" );
}

jugg_canreload( var_0 )
{
    var_1 = var_0.attacker;
    jug_trigger_spawn( var_1 );
    thread jug_encounter_test( var_1, 1 );
}

jug_encounter_test( var_0, var_1, var_2 )
{
    level endon( "game_ended" );
    thread jeep_initdamage( var_0, var_1 );
    self setscriptablepartstate( "effects", "activeDestroyStart", 0 );
    self._id_122F2 = 1;

    if ( !isdefined( var_2 ) )
        var_2 = 0.15;

    wait( var_2 );
    self.explosion delete();

    if ( isdefined( self ) )
        self setscriptablepartstate( "effects", "activeDestroyEnd", 0 );
}

jeep_initdamage( var_0, var_1 )
{
    level endon( "game_ended" );
    self notify( "disperse" );
    self notify( "death" );
    self setscriptablepartstate( "hack_usable", "off" );
    self.owner scripts\cp\vehicles\vehicle_compass_cp::_id_12032( "super_trophy", self.usedcount, var_0, var_1 );
    scripts\mp\analyticslog::logevent_fieldupgradeexpired( self.owner, self.superid, self.usedcount, istrue( var_1 ) );
    level.mines[self getentitynumber()] = undefined;
    self setcandamage( 0 );

    if ( !istrue( self.issuper ) )
    {
        self makeunusable();
        scripts\mp\weapons::makeexplosiveunusuabletag();
    }

    scripts\cp_mp\entityheadicons::setheadicon_deleteicon( self.headiconid );
    self.headiconid = undefined;
    self.exploding = 1;

    if ( isdefined( self.owner ) )
    {
        self.owner notify( "trophy_update", 0 );
        self.owner scripts\mp\weapons::removeequip( self );
    }

    jugg_canuseweaponpickups();
    self setscriptablepartstate( "anims", "neutral", 0 );
    self setscriptablepartstate( "effects", "activeDestroyEnd", 0 );
    wait 2.0;
    scripts\cp_mp\ent_manager::deregisterspawn();
    self delete();
}

jug_trigger_spawn( var_0 )
{
    if ( istrue( scripts\cp_mp\utility\player_utility::playersareenemies( self.owner, var_0 ) ) )
    {
        var_0 notify( "destroyed_equipment" );
        var_0 thread scripts\mp\utility\points::giveunifiedpoints( "destroyed_equipment" );
        var_0 thread scripts\mp\battlechatter_mp::equipmentdestroyed( self );
    }
}

jeep_horn()
{
    var_0 = spawn( "script_model", self.origin );
    var_0.killcament = self;
    var_0.owner = self.owner;
    var_0.team = self.team;
    var_0.equipmentref = self.equipmentref;
    var_0.weapon_name = self.weapon_name;
    var_0 setotherent( var_0.owner );
    var_0 setentityowner( var_0.owner );
    var_0 setmodel( "trophy_system_mp_explode" );
    var_0.explode1available = 1;
    return var_0;
}

jeep_initcollision()
{
    self endon( "death" );
    self endon( "missile_stuck" );
    var_0 = getdvarfloat( "scr_trophy_proj_hide_duration", 0 );
    self setscriptablepartstate( "visibility", "hide", 0 );
    wait( var_0 );
    self setscriptablepartstate( "visibility", "show", 0 );
}

jeep( var_0 )
{
    self endon( "death" );
    self endon( "missile_stuck" );
    var_0 endon( "disconnect" );
    var_1 = scripts\engine\utility::_id_143B9( 2, "touching_platform" );

    if ( var_1 == "timeout" )
        return;

    var_2 = undefined;
    var_3 = tablesort( self.origin, 500, 500 );
    var_3[var_3.size] = self;
    var_4 = scripts\engine\trace::create_contents( 0, 1, 1, 1, 0, 1, 1, 0, 1 );
    var_5 = self.origin;
    var_6 = -2000.0;
    var_7 = self.origin + ( 0.0, 0.0, var_6 );
    var_8 = scripts\engine\trace::ray_trace( var_5, var_7, var_3, var_4 );

    if ( var_8["fraction"] < 1.0 )
    {
        var_2 = var_8["entity"];

        if ( isdefined( var_2 ) )
        {
            if ( tugofwar_tank( var_2 ) )
                self.origin = var_0.origin;
        }
    }
}

tugofwar_tank( var_0 )
{
    if ( isdefined( level._id_145F1 ) )
    {
        foreach ( var_2 in level._id_145F1._id_13C8D )
        {
            if ( var_2 == var_0 )
                return 1;
            else if ( isdefined( var_2.wz_tease ) && var_2.wz_tease == var_0 )
                return 1;
        }
    }

    return 0;
}

jugg_health_debug()
{
    if ( self.owner scripts\mp\equipment::hasequipment( "equip_decon_station" ) )
        self.owner javelin_interact_monitor( self.ammo );
}
